// Prisma Schema for NextAuth.js
// Compatible with Prisma 6

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Enums ====================

enum UserRole {
  system_admin
  school_admin
  class_teacher
}

enum ProjectRole {
  lead
  care
  coordinate
}

enum RiskLevel {
  blue
  green
  yellow
  orange
  red
}

enum ActivityStatus {
  locked
  in_progress
  pending_assessment
  completed
}

enum ProblemType {
  internal
  external
}

// ==================== Models ====================



// School - โรงเรียน
model School {
  id        String    @id @default(cuid())
  name      String    // ชื่อโรงเรียน
  province  String?   // จังหวัด
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  users          User[]
  teacherInvites TeacherInvite[]
  students       Student[]
  classes        SchoolClass[]
  teacherRoster  SchoolTeacherRoster[]

  @@map("schools")
}

// School Class - ห้องเรียนของโรงเรียน (flexible, free-form)
model SchoolClass {
  id        String   @id @default(cuid())
  schoolId  String
  name      String   // free-form: "ม.1/1", "ป.6/2", อะไรก็ได้
  createdAt DateTime @default(now())

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
  @@index([schoolId])
  @@map("school_classes")
}

// User Model for JWT-based Authentication
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole  @default(school_admin) // school_admin (invite only), class_teacher (invite only)
  isPrimary     Boolean   @default(false) // true = invited by system_admin, can manage school data
  schoolId      String?   // FK to School
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  school                School?             @relation(fields: [schoolId], references: [id])
  teacher               Teacher?
  teacherInvites        TeacherInvite[]
  phqResults            PhqResult[]
  assignedActivities    ActivityProgress[]  @relation("TeacherActivities")
  worksheetUploads      WorksheetUpload[]
  counselingSessions    CounselingSession[] @relation("CounselingSessions")
  schoolAdminInvites    SchoolAdminInvite[] @relation("CreatedSchoolAdminInvites")
  referralsFrom         StudentReferral[]   @relation("ReferralsFrom")
  referralsTo           StudentReferral[]   @relation("ReferralsTo")

  @@map("users")
  @@index([email])
}

// Academic Year - ปีการศึกษาและเทอม
model AcademicYear {
  id          String    @id @default(cuid())
  year        Int       // ปีการศึกษา เช่น 2567
  semester    Int       // เทอม: 1 หรือ 2
  startDate   DateTime  // วันเริ่มเทอม
  endDate     DateTime  // วันสิ้นสุดเทอม
  isCurrent   Boolean   @default(false) // เทอมปัจจุบัน
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  teachers       Teacher[]
  teacherInvites TeacherInvite[]
  phqResults     PhqResult[]

  @@unique([year, semester]) // ห้ามซ้ำ ปี+เทอม
  @@map("academic_years")
}

// Teacher profile - ข้อมูลครู
model Teacher {
  id              String        @id @default(cuid())
  userId          String        @unique
  firstName       String        // ชื่อ
  lastName        String        // สกุล
  age             Int           // อายุ
  advisoryClass   String        // ชั้นที่ปรึกษา เช่น "ม.1/1"
  academicYearId  String        // FK to AcademicYear
  schoolRole      String        // บทบาทหน้าที่ในโรงเรียน
  projectRole     ProjectRole        // บทบาทหน้าที่ในโครงการครูนางฟ้า: LEAD, CARE, COORDINATE
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id])

  @@map("teachers")
}

// Teacher Invite - คำเชิญครูผู้ดูแล
model TeacherInvite {
  id              String    @id @default(cuid())
  token           String    @unique
  email           String
  firstName       String
  lastName        String
  age             Int
  userRole        UserRole  // SCHOOL_ADMIN or CLASS_TEACHER
  advisoryClass   String
  academicYearId  String
  schoolId        String
  schoolRole      String
  projectRole     ProjectRole    // lead, care, coordinate
  invitedById     String
  expiresAt       DateTime
  acceptedAt      DateTime?
  createdAt       DateTime  @default(now())

  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])
  school          School       @relation(fields: [schoolId], references: [id])
  invitedBy       User         @relation(fields: [invitedById], references: [id])

  @@map("teacher_invites")
}

enum Gender {
  MALE
  FEMALE

  @@map("gender")
}

// Student - นักเรียน
model Student {
  id            String   @id @default(cuid())
  studentId     String   // รหัสนักเรียน (required)
  firstName     String   // ชื่อ
  lastName      String   // สกุล
  gender        Gender?  // เพศ (optional เพื่อรองรับข้อมูลเก่า)
  age           Int?     // อายุ (optional เพื่อรองรับข้อมูลเก่า)
  class         String   // ห้อง เช่น "ม.1/1"
  schoolId      String   // FK to School
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  school           School             @relation(fields: [schoolId], references: [id])
  phqResults       PhqResult[]
  activityProgress ActivityProgress[]
  counselingSessions CounselingSession[]
  referral         StudentReferral?

  @@unique([studentId, schoolId]) // ป้องกันซ้ำ: รหัสนักเรียน + โรงเรียน
  @@index([schoolId, class]) // For filtering by school and class
  @@index([firstName, lastName]) // For name search
  @@map("students")
}

// PHQ-A Result - ผลคัดกรองสุขภาพจิต
model PhqResult {
  id              String   @id @default(cuid())
  studentId       String   // FK to Student
  academicYearId  String   // FK to AcademicYear
  importedById    String   // FK to User (ครูที่ import)
  assessmentRound Int      @default(1) // ครั้งที่ 1 หรือ 2
  
  // คะแนนแต่ละข้อ (0-3)
  q1              Int
  q2              Int
  q3              Int
  q4              Int
  q5              Int
  q6              Int
  q7              Int
  q8              Int
  q9              Int
  
  // ข้อพิเศษ (ตอบใช่/ไม่ใช่)
  q9a             Boolean  @default(false) // ความคิดทำร้ายตัวเอง
  q9b             Boolean  @default(false) // ความคิดทำร้ายผู้อื่น
  
  // ผลคำนวณ
  totalScore      Int      // รวมคะแนน q1-q9
  riskLevel       RiskLevel   // BLUE, GREEN, YELLOW, ORANGE, RED
  referredToHospital Boolean @default(false) // ส่งต่อโรงพยาบาล
  hospitalName       String?                // ชื่อโรงพยาบาลที่ส่งต่อ
  
  createdAt       DateTime @default(now())

  student         Student            @relation(fields: [studentId], references: [id], onDelete: Cascade)
  academicYear    AcademicYear       @relation(fields: [academicYearId], references: [id])
  importedBy      User               @relation(fields: [importedById], references: [id])
  activityProgress ActivityProgress[]

  @@unique([studentId, academicYearId, assessmentRound]) // ป้องกันซ้ำ
  @@index([studentId, createdAt(sort: Desc)]) // For DISTINCT ON latest per student
  @@index([studentId, academicYearId, assessmentRound]) // For trend queries
  @@map("phq_results")
}

// Activity Progress - ความคืบหน้ากิจกรรมช่วยเหลือนักเรียน
model ActivityProgress {
  id              String    @id @default(cuid())
  studentId       String    // FK to Student
  phqResultId     String    // FK to PhqResult (ผลคัดกรองที่ใช้)
  activityNumber  Int       // 1, 2, 3, 4, 5
  
  // สถานะ: locked, in_progress, pending_assessment, completed
  status          ActivityStatus    @default(locked)
  unlockedAt      DateTime? // วันที่ปลดล็อค
  completedAt     DateTime? // วันที่เสร็จสิ้น
  
  // ข้อมูลครู
  scheduledDate   DateTime? // วันที่นัดหมาย
  teacherId       String?   // FK to User (ครูผู้ทำกิจกรรม)
  teacherNotes    String?   // บันทึกของครู
  
  // แบบประเมินจากใบงาน
  internalProblems String?  // ปัญหาภายใน
  externalProblems String?  // ปัญหาภายนอก
  problemType      ProblemType?  // INTERNAL หรือ EXTERNAL
  assessedAt       DateTime? // วันที่ทำแบบประเมิน
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  student          Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  phqResult        PhqResult         @relation(fields: [phqResultId], references: [id])
  teacher          User?             @relation("TeacherActivities", fields: [teacherId], references: [id])
  worksheetUploads WorksheetUpload[]

  @@unique([studentId, phqResultId, activityNumber])
  @@index([phqResultId, status]) // For activity progress aggregation
  @@map("activity_progress")
}

// Worksheet Upload - ใบงานที่อัปโหลด
model WorksheetUpload {
  id                  String   @id @default(cuid())
  activityProgressId  String   // FK to ActivityProgress
  
  fileName            String   // ชื่อไฟล์
  fileUrl             String   // URL ของไฟล์ (path ใน public/uploads)
  fileType            String   // image/jpeg, image/png, application/pdf
  fileSize            Int      // ขนาดไฟล์ (bytes)
  
  uploadedById        String   // FK to User (ครูที่อัปโหลด)
  uploadedAt          DateTime @default(now())

  activityProgress    ActivityProgress @relation(fields: [activityProgressId], references: [id], onDelete: Cascade)
  uploadedBy          User             @relation(fields: [uploadedById], references: [id])

  @@map("worksheet_uploads")
}

// Counseling Session - บันทึกการให้คำปรึกษารายบุคคล
model CounselingSession {
  id              String    @id @default(cuid())
  studentId       String    // FK to Student
  sessionNumber   Int       // ครั้งที่
  sessionDate     DateTime  // วันที่
  counselorName   String    // ครูที่ปรึกษา
  summary         String    @db.Text // สรุปประเด็นที่ปรึกษา
  createdById     String    // FK to User (ครูที่บันทึก)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  createdBy       User      @relation("CounselingSessions", fields: [createdById], references: [id])

  @@map("counseling_sessions")
}

// System Admin Whitelist - รายชื่อ email ที่สามารถเป็น system_admin ได้
model SystemAdminWhitelist {
  id        String   @id @default(cuid())
  email     String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  @@map("system_admin_whitelist")
}

// School Admin Invite - คำเชิญสร้างบัญชี admin (system_admin หรือ school_admin)
model SchoolAdminInvite {
  id        String    @id @default(cuid())
  token     String    @unique
  email     String    @unique  // email ที่ระบุล่วงหน้า
  role      UserRole  @default(school_admin) // role ที่จะได้รับเมื่อ accept invite
  usedAt    DateTime?
  expiresAt DateTime
  createdBy String
  createdAt DateTime  @default(now())

  creator   User @relation("CreatedSchoolAdminInvites", fields: [createdBy], references: [id])

  @@map("school_admin_invites")
}

// School Teacher Roster - รายชื่อครูที่ลงไว้ล่วงหน้า (ก่อน invite)
model SchoolTeacherRoster {
  id              String       @id @default(cuid())
  schoolId        String
  firstName       String
  lastName        String
  email           String?      // optional — ใช้ pre-fill invite
  age             Int          // อายุ
  userRole        UserRole     // school_admin | class_teacher
  advisoryClass   String       // ห้องที่ปรึกษา (class_teacher) หรือ "ทุกห้อง" (school_admin)
  schoolRole      String       // บทบาทในโรงเรียน
  projectRole     ProjectRole  // lead, care, coordinate
  inviteSent      Boolean      @default(false)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  school School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, email])
  @@index([schoolId])
  @@map("school_teacher_roster")
}

// Password Reset Token - โทเค็นรีเซ็ตรหัสผ่าน
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
  @@map("password_reset_token")
}

// Student Referral - ส่งต่อนักเรียนระหว่างครู
model StudentReferral {
  id                String   @id @default(cuid())
  studentId         String   @unique  // 1 referral ต่อ 1 นักเรียน
  fromTeacherUserId String   // userId ครูที่ส่งต่อ
  toTeacherUserId   String   // userId ครูที่รับดูแล
  createdAt         DateTime @default(now())

  student     Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  fromTeacher User    @relation("ReferralsFrom", fields: [fromTeacherUserId], references: [id])
  toTeacher   User    @relation("ReferralsTo", fields: [toTeacherUserId], references: [id])

  @@index([fromTeacherUserId])
  @@index([toTeacherUserId])
  @@map("student_referrals")
}
